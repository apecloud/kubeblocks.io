"use strict";(self.webpackChunkkubeblocks_io=self.webpackChunkkubeblocks_io||[]).push([[4133],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>k});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=a.createContext({}),p=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(i.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,i=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),m=p(n),d=r,k=m["".concat(i,".").concat(d)]||m[d]||u[d]||s;return n?a.createElement(k,l(l({ref:t},c),{},{components:n})):a.createElement(k,l({ref:t},c))}));function k(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,l=new Array(s);l[0]=d;var o={};for(var i in t)hasOwnProperty.call(t,i)&&(o[i]=t[i]);o.originalType=e,o[m]="string"==typeof e?e:r,l[1]=o;for(var p=2;p<s;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},45053:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>o,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const s={title:"Scale for ApeCloud MySQL",description:"How to scale a MySQL cluster, horizontal scaling, vertical scaling",sidebar_position:2,sidebar_label:"Scale"},l="Scale for ApeCloud MySQL",o={unversionedId:"user_docs/kubeblocks-for-mysql/cluster-management/scale-for-apecloud-mysql",id:"user_docs/kubeblocks-for-mysql/cluster-management/scale-for-apecloud-mysql",title:"Scale for ApeCloud MySQL",description:"How to scale a MySQL cluster, horizontal scaling, vertical scaling",source:"@site/docs/user_docs/kubeblocks-for-mysql/cluster-management/scale-for-apecloud-mysql.md",sourceDirName:"user_docs/kubeblocks-for-mysql/cluster-management",slug:"/user_docs/kubeblocks-for-mysql/cluster-management/scale-for-apecloud-mysql",permalink:"/docs/next/user_docs/kubeblocks-for-mysql/cluster-management/scale-for-apecloud-mysql",draft:!1,editUrl:"https://github.com/apecloud/kubeblocks/tree/main/docs/user_docs/kubeblocks-for-mysql/cluster-management/scale-for-apecloud-mysql.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Scale for ApeCloud MySQL",description:"How to scale a MySQL cluster, horizontal scaling, vertical scaling",sidebar_position:2,sidebar_label:"Scale"},sidebar:"docs",previous:{title:"Create and connect",permalink:"/docs/next/user_docs/kubeblocks-for-mysql/cluster-management/create-and-connect-a-mysql-cluster"},next:{title:"Expand volume",permalink:"/docs/next/user_docs/kubeblocks-for-mysql/cluster-management/expand-volume"}},i={},p=[{value:"Vertical scaling",id:"vertical-scaling",level:2},{value:"Before you start",id:"before-you-start",level:3},{value:"Steps",id:"steps",level:3},{value:"Horizontal scaling",id:"horizontal-scaling",level:2},{value:"Before you start",id:"before-you-start-1",level:3},{value:"Steps",id:"steps-1",level:3},{value:"Handle the snapshot exception",id:"handle-the-snapshot-exception",level:3}],c={toc:p},m="wrapper";function u(e){let{components:t,...n}=e;return(0,r.kt)(m,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"scale-for-apecloud-mysql"},"Scale for ApeCloud MySQL"),(0,r.kt)("p",null,"You can scale ApeCloud MySQL DB instances in two ways, horizontal scaling and vertical scaling. "),(0,r.kt)("h2",{id:"vertical-scaling"},"Vertical scaling"),(0,r.kt)("p",null,"You can vertically scale a cluster by changing resource requirements and limits (CPU and storage). For example, if you need to change the resource demand from 1C2G to 2C4G, vertical scaling is what you need."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"During the vertical scaling process, all pods restart in the order of learner -> follower -> leader and the leader pod may change after the restarting.")),(0,r.kt)("h3",{id:"before-you-start"},"Before you start"),(0,r.kt)("p",null,"Run the command below to check whether the cluster STATUS is ",(0,r.kt)("inlineCode",{parentName:"p"},"Running"),". Otherwise, the following operations may fail."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kbcli cluster list <name>\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Example"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kbcli cluster list mysql-cluster\n>\nNAME                 NAMESPACE        CLUSTER-DEFINITION        VERSION                TERMINATION-POLICY        STATUS         CREATED-TIME\nmysql-cluster        default          apecloud-mysql            ac-mysql-8.0.30        Delete                    Running        Jan 29,2023 14:29 UTC+0800\n")),(0,r.kt)("h3",{id:"steps"},"Steps"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Change configuration. There are 3 ways to apply vertical scaling."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Option 1.")," (",(0,r.kt)("strong",{parentName:"p"},"Recommended"),") Use kbcli"),(0,r.kt)("p",{parentName:"li"},"Configure the parameters ",(0,r.kt)("inlineCode",{parentName:"p"},"component-names"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"requests"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"limits")," and run the command."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Example"))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'kbcli cluster vscale mysql-cluster \\\n--component-names="mysql" \\\n--requests.memory="2Gi" --requests.cpu="1" \\\n--limits.memory="4Gi" --limits.cpu="2"\n')),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"component-names")," describes the component name ready for vertical scaling."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"requests")," describes the minimum amount of computing resources required. If ",(0,r.kt)("inlineCode",{parentName:"li"},"requests")," is omitted for a container, it uses the ",(0,r.kt)("inlineCode",{parentName:"li"},"limits")," value if ",(0,r.kt)("inlineCode",{parentName:"li"},"limits")," is explicitly specified, otherwise uses an implementation-defined value. For more details, see ",(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/"},"Resource Management for Pods and Containers"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"--limits")," describes the maximum amount of computing resources allowed. For more details, see ",(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/"},"Resource Management for Pods and Containers"))),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Option 2.")," Create an OpsRequest"),(0,r.kt)("p",{parentName:"li"},"Run the command below to apply an OpsRequest to the specified cluster. Configure the parameters according to your needs."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'kubectl apply -f - <<EOF\napiVersion: apps.kubeblocks.io/v1alpha1\nkind: OpsRequest\nmetadata:\n  name: ops-vertical-scaling\nspec:\n  clusterRef: mysql-cluster\n  type: VerticalScaling \n  verticalScaling:\n  - componentName: mysql\n    requests:\n      memory: "2Gi"\n      cpu: "1000m"\n    limits:\n      memory: "4Gi"\n      cpu: "2000m"\nEOF\n')),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Option 3.")," Change the YAML file of the cluster"),(0,r.kt)("p",{parentName:"li"},"Change the configuration of ",(0,r.kt)("inlineCode",{parentName:"p"},"spec.components.resources")," in the YAML file. ",(0,r.kt)("inlineCode",{parentName:"p"},"spec.components.resources")," controls the requirement and limit of resources and changing them triggers a vertical scaling. "),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Example"))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-YAML"},'apiVersion: apps.kubeblocks.io/v1alpha1\nkind: Cluster\nmetadata:\n  name: mysql-cluster\n  namespace: default\nspec:\n  clusterDefinitionRef: apecloud-mysql\n  clusterVersionRef: ac-mysql-8.0.30\n  components:\n  - name: mysql\n    type: mysql\n    replicas: 1\n    resources: # Change the values of resources.\n      requests:\n        memory: "2Gi"\n        cpu: "1000m"\n      limits:\n        memory: "4Gi"\n        cpu: "2000m"\n    volumeClaimTemplates:\n    - name: data\n      spec:\n        accessModes:\n          - ReadWriteOnce\n        resources:\n          requests:\n            storage: 1Gi\n  terminationPolicy: Halt\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Validate the vertical scaling.\nRun the command below to check the cluster status to identify the vertical scaling status."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kbcli cluster list <name>\n")),(0,r.kt)("p",{parentName:"li"}," ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Example"))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kbcli cluster list mysql-cluster\n>\nNAME                 NAMESPACE        CLUSTER-DEFINITION        VERSION                TERMINATION-POLICY        STATUS          CREATED-TIME\nmysql-cluster        default          apecloud-mysql            ac-mysql-8.0.30        Delete                    Updating        Jan 29,2023 14:29 UTC+0800\n")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"STATUS=Running: it means the vertical scaling operation is applied."),(0,r.kt)("li",{parentName:"ul"},"STATUS=Updating: it means the vertical scaling is in progress."),(0,r.kt)("li",{parentName:"ul"},"STATUS=Abnormal: it means the vertical scaling is abnormal. The reason may be the normal instances number is less than the total instance number or the leader instance is running properly while others are abnormal. ",(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},"To solve the problem, you can check manually to see whether resources are sufficient. If AutoScaling is supported, the system recovers when there are enough resources, otherwise, you can create enough resources and check the result with kubectl describe command.")))))),(0,r.kt)("h2",{id:"horizontal-scaling"},"Horizontal scaling"),(0,r.kt)("p",null,"Horizontal scaling changes the amount of pods. For example, you can apply horizontal scaling to scale up from three pods to five pods. The scaling process includes the backup and restoration of data."),(0,r.kt)("h3",{id:"before-you-start-1"},"Before you start"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Refer to ",(0,r.kt)("a",{parentName:"p",href:"/docs/next/user_docs/kubeblocks-for-mysql/backup-and-restore/backup-and-restore-for-mysql-standalone"},"Backup and restore for MySQL")," to make sure the EKS environment is configured properly since the horizontal scaling relies on the backup function.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Run the command below to check whether the cluster STATUS is ",(0,r.kt)("inlineCode",{parentName:"p"},"Running"),". Otherwise, the following operations may fail."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kbcli cluster list <name>\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Example"))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kbcli cluster list mysql-cluster\n>\nNAME                 NAMESPACE        CLUSTER-DEFINITION        VERSION                TERMINATION-POLICY        STATUS         CREATED-TIME\nmysql-cluster        default          apecloud-mysql            ac-mysql-8.0.30        Delete                    Running        Jan 29,2023 14:29 UTC+0800\n")))),(0,r.kt)("h3",{id:"steps-1"},"Steps"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Change configuration. There are 3 ways to apply horizontal scaling."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Option 1.")," (",(0,r.kt)("strong",{parentName:"p"},"Recommended"),") Use kbcli"),(0,r.kt)("p",{parentName:"li"},"Configure the parameters ",(0,r.kt)("inlineCode",{parentName:"p"},"component-names")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"replicas"),", and run the command."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Example"))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'kbcli cluster hscale mysql-cluster \\\n--component-names="mysql" --replicas=3\n')),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"--component-names")," describes the component name ready for vertical scaling."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"--replicas")," describe the replicas with the specified components.")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Option 2.")," Create an OpsRequest"),(0,r.kt)("p",{parentName:"li"},"Run the command below to apply an OpsRequest to the specified cluster. Configure the parameters according to your needs."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f - <<EOF\napiVersion: apps.kubeblocks.io/v1alpha1\nkind: OpsRequest\nmetadata:\n  name: ops-horizontal-scaling\nspec:\n  clusterRef: mysql-cluster\n  type: HorizontalScaling\n  horizontalScaling:\n  - componentName: mysql\n    replicas: 3\nEOF\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Option 3.")," Change the YAML file of the cluster"),(0,r.kt)("p",{parentName:"li"},"Change the configuration of ",(0,r.kt)("inlineCode",{parentName:"p"},"spec.components.replicas")," in the YAML file. ",(0,r.kt)("inlineCode",{parentName:"p"},"spec.components.replicas")," stand for the pod amount and changing this value triggers a horizontal scaling of a cluster. "),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Example"))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-YAML"},"apiVersion: apps.kubeblocks.io/v1alpha1\nkind: Cluster\nmetadata:\n apiVersion: apps.kubeblocks.io/v1alpha1\nkind: Cluster\nmetadata:\n  name: mysql-cluster\n  namespace: default\nspec:\n  clusterDefinitionRef: apecloud-mysql\n  clusterVersionRef: ac-mysql-8.0.30\n  components:\n  - name: mysql\n    type: mysql\n    replicas: 1 # Change the pod amount.\n    volumeClaimTemplates:\n    - name: data\n      spec:\n        accessModes:\n          - ReadWriteOnce\n        resources:\n          requests:\n            storage: 1Gi\n terminationPolicy: Halt\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Validate the horizontal scaling operation.\nRun the command below to check the cluster STATUS to identify the horizontal scaling status."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kbcli cluster list mysql-cluster\n")),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"STATUS=Updating: it means horizontal scaling is being applied."),(0,r.kt)("li",{parentName:"ul"},"STATUS=Running: it means horizontal scaling is applied.")))),(0,r.kt)("h3",{id:"handle-the-snapshot-exception"},"Handle the snapshot exception"),(0,r.kt)("p",null,"If ",(0,r.kt)("inlineCode",{parentName:"p"},"STATUS=ConditionsError")," occurs during the horizontal scaling process, you can find the cause from ",(0,r.kt)("inlineCode",{parentName:"p"},"cluster.status.condition.message")," for troubleshooting.\nIn the example below, a snapshot exception occurs."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'Status:\n  conditions: \n  - lastTransitionTime: "2023-02-08T04:20:26Z"\n    message: VolumeSnapshot/mysql-cluster-mysql-scaling-dbqgp: Failed to set default snapshot\n      class with error cannot find default snapshot class\n    reason: ApplyResourcesFailed\n    status: "False"\n    type: ApplyResources\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Reason"))),(0,r.kt)("p",null,"This exception occurs because the ",(0,r.kt)("inlineCode",{parentName:"p"},"VolumeSnapshotClass")," is not configured. This exception can be fixed after configuring ",(0,r.kt)("inlineCode",{parentName:"p"},"VolumeSnapshotClass"),", but the horizontal scaling cannot continue to run. It is because the wrong backup (volumesnapshot is generated by backup) and volumesnapshot generated before still exist. Delete these two wrong resources and then KubeBlocks re-generates new resources."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Steps:"))," "),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configure the VolumeSnapshotClass by running the command below."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'kubectl create -f - <<EOF\napiVersion: snapshot.storage.k8s.io/v1\nkind: VolumeSnapshotClass\nmetadata:\n  name: csi-aws-vsc\n  annotations:\n    snapshot.storage.kubernetes.io/is-default-class: "true"\ndriver: ebs.csi.aws.com\ndeletionPolicy: Delete\nEOF\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Delete the wrong backup (volumesnapshot is generated by backup) and volumesnapshot resources."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl delete backup -l app.kubernetes.io/instance=mysql-cluster\n\nkubectl delete volumesnapshot -l app.kubernetes.io/instance=mysql-cluster\n")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Result"))),(0,r.kt)("p",null,"The horizontal scaling continues after backup and volumesnapshot are deleted and the cluster restores to running status."))}u.isMDXComponent=!0}}]);